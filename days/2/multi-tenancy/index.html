<!DOCTYPE html><html lang="en" data-theme="dark"> <head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="canonical" href="https://agentcore-initiative.aws/days/2/multi-tenancy/"><!-- Favicon --><link rel="icon" type="image/svg+xml" href="/favicon.svg"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><!-- Primary Meta Tags --><title>Multi-Tenancy - Day 2 | The AgentCore Initiative</title><meta name="title" content="Multi-Tenancy - Day 2 | The AgentCore Initiative"><meta name="description" content="Day 2: Age of Ultron - Identity + AgentCore Gateway"><!-- Open Graph / Facebook --><meta property="og:type" content="website"><meta property="og:url" content="https://agentcore-initiative.aws/days/2/multi-tenancy/"><meta property="og:title" content="Multi-Tenancy - Day 2 | The AgentCore Initiative"><meta property="og:description" content="Day 2: Age of Ultron - Identity + AgentCore Gateway"><meta property="og:image" content="https://agentcore-initiative.aws/images/og/default.png"><!-- Twitter --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:url" content="https://agentcore-initiative.aws/days/2/multi-tenancy/"><meta name="twitter:title" content="Multi-Tenancy - Day 2 | The AgentCore Initiative"><meta name="twitter:description" content="Day 2: Age of Ultron - Identity + AgentCore Gateway"><meta name="twitter:image" content="https://agentcore-initiative.aws/images/og/default.png"><!-- Fonts - Plus Jakarta Sans & Geist Mono --><link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet"><!-- Theme initialization (prevents flash) --><script>
      (function () {
        const stored = localStorage.getItem('agentcore-initiative-progress');
        let theme = 'dark';
        if (stored) {
          try {
            const progress = JSON.parse(stored);
            theme = progress.theme || 'dark';
          } catch (e) {}
        }
        if (theme === 'system') {
          theme = window.matchMedia('(prefers-color-scheme: light)').matches
            ? 'light'
            : 'dark';
        }
        document.documentElement.setAttribute('data-theme', theme);
      })();
    </script><link rel="stylesheet" href="/_astro/_slug_.B9ZU_V3V.css">
<style>.pagination[data-astro-cid-ucfvjs2v]{display:flex;justify-content:space-between;gap:1rem}.pagination__link[data-astro-cid-ucfvjs2v]{flex:1;max-width:50%;padding:1rem 1.25rem;background:var(--color-bg-elevated);border:var(--border-subtle);border-radius:var(--radius-lg);text-decoration:none;transition:all var(--transition-fast)}.pagination__link[data-astro-cid-ucfvjs2v]:hover{background:var(--color-bg-secondary);border-color:var(--border-default)}.pagination__link--prev[data-astro-cid-ucfvjs2v]{text-align:left}.pagination__link--next[data-astro-cid-ucfvjs2v]{text-align:right;margin-left:auto}.pagination__label[data-astro-cid-ucfvjs2v]{display:block;font-size:.75rem;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--color-text-muted);margin-bottom:.25rem}.pagination__title[data-astro-cid-ucfvjs2v]{display:block;font-size:.9375rem;font-weight:500;color:var(--color-text-primary)}
</style>
<link rel="stylesheet" href="/_astro/_slug_.CP5296fy.css"><style>.callout[data-astro-cid-wi7smz4x]{display:flex;gap:1rem;padding:1rem 1.25rem;border-radius:var(--radius-lg);margin:1.5rem 0;border-left:4px solid}.callout--info[data-astro-cid-wi7smz4x]{background:#3b82f614;border-left-color:var(--color-accent-primary)}.callout--info[data-astro-cid-wi7smz4x] .callout__icon[data-astro-cid-wi7smz4x]{color:var(--color-accent-primary)}.callout--warning[data-astro-cid-wi7smz4x]{background:#f59e0b14;border-left-color:var(--color-accent-warning)}.callout--warning[data-astro-cid-wi7smz4x] .callout__icon[data-astro-cid-wi7smz4x]{color:var(--color-accent-warning)}.callout--danger[data-astro-cid-wi7smz4x]{background:#ef444414;border-left-color:var(--color-accent-danger)}.callout--danger[data-astro-cid-wi7smz4x] .callout__icon[data-astro-cid-wi7smz4x]{color:var(--color-accent-danger)}.callout--success[data-astro-cid-wi7smz4x]{background:#10b98114;border-left-color:var(--color-accent-success)}.callout--success[data-astro-cid-wi7smz4x] .callout__icon[data-astro-cid-wi7smz4x]{color:var(--color-accent-success)}.callout--tip[data-astro-cid-wi7smz4x]{background:#8b5cf614;border-left-color:var(--color-accent-purple)}.callout--tip[data-astro-cid-wi7smz4x] .callout__icon[data-astro-cid-wi7smz4x]{color:var(--color-accent-purple)}.callout__icon[data-astro-cid-wi7smz4x]{flex-shrink:0;width:1.25rem;height:1.25rem;margin-top:.125rem}.callout__content[data-astro-cid-wi7smz4x]{flex:1;min-width:0}.callout__title[data-astro-cid-wi7smz4x]{font-weight:600;font-size:.9375rem;color:var(--color-text-primary);margin-bottom:.25rem}.callout__body[data-astro-cid-wi7smz4x]{font-size:.9375rem;color:var(--color-text-secondary);line-height:1.6}.callout__body[data-astro-cid-wi7smz4x] p{margin:0}.callout__body[data-astro-cid-wi7smz4x] p+p{margin-top:.5rem}.callout__body[data-astro-cid-wi7smz4x] code{font-size:.85em}.callout__body[data-astro-cid-wi7smz4x] a{font-weight:500}
</style></head> <body>  <header class="header" data-astro-cid-mb6pvx4c> <div class="header__container" data-astro-cid-mb6pvx4c> <!-- Logo --> <a href="/" class="header__logo" aria-label="Home" data-astro-cid-mb6pvx4c> <svg class="header__logo-icon" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg" data-astro-cid-mb6pvx4c> <circle cx="16" cy="16" r="14" stroke="currentColor" stroke-width="2" data-astro-cid-mb6pvx4c></circle> <path d="M16 6 L22 12 L16 18 L10 12 Z" fill="currentColor" opacity="0.5" data-astro-cid-mb6pvx4c></path> <circle cx="16" cy="16" r="4" fill="currentColor" data-astro-cid-mb6pvx4c></circle> </svg> <span class="header__logo-text" data-astro-cid-mb6pvx4c>AgentCore Initiative</span> </a> <!-- Desktop Navigation --> <nav class="header__nav hide-mobile" aria-label="Main navigation" data-astro-cid-mb6pvx4c> <ul class="header__nav-list" data-astro-cid-mb6pvx4c> <li data-astro-cid-mb6pvx4c> <a href="/days" class="header__nav-link header__nav-link--active" data-astro-cid-mb6pvx4c> Course </a> </li><li data-astro-cid-mb6pvx4c> <a href="/troubleshooting" class="header__nav-link" data-astro-cid-mb6pvx4c> Troubleshooting </a> </li><li data-astro-cid-mb6pvx4c> <a href="/reference" class="header__nav-link" data-astro-cid-mb6pvx4c> Reference </a> </li> </ul> </nav> <!-- Actions --> <div class="header__actions" data-astro-cid-mb6pvx4c> <!-- Theme Toggle Button (placeholder - will be React component) --> <button id="theme-toggle" class="header__theme-toggle" aria-label="Toggle theme" type="button" data-astro-cid-mb6pvx4c> <svg class="header__theme-icon header__theme-icon--dark" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" data-astro-cid-mb6pvx4c> <circle cx="12" cy="12" r="5" data-astro-cid-mb6pvx4c></circle> <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" data-astro-cid-mb6pvx4c></path> </svg> <svg class="header__theme-icon header__theme-icon--light" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" data-astro-cid-mb6pvx4c> <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" data-astro-cid-mb6pvx4c></path> </svg> </button> <!-- Mobile Menu Toggle --> <button id="mobile-menu-toggle" class="header__mobile-toggle hide-desktop" aria-label="Toggle menu" aria-expanded="false" type="button" data-astro-cid-mb6pvx4c> <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" data-astro-cid-mb6pvx4c> <path class="menu-icon" d="M4 6h16M4 12h16M4 18h16" data-astro-cid-mb6pvx4c></path> <path class="close-icon" d="M6 6l12 12M6 18L18 6" style="display: none" data-astro-cid-mb6pvx4c></path> </svg> </button> </div> </div> <!-- Mobile Navigation --> <nav id="mobile-nav" class="header__mobile-nav hide-desktop" aria-label="Mobile navigation" hidden data-astro-cid-mb6pvx4c> <ul class="header__mobile-nav-list" data-astro-cid-mb6pvx4c> <li data-astro-cid-mb6pvx4c> <a href="/days" class="header__mobile-nav-link header__mobile-nav-link--active" data-astro-cid-mb6pvx4c> Course </a> </li><li data-astro-cid-mb6pvx4c> <a href="/troubleshooting" class="header__mobile-nav-link" data-astro-cid-mb6pvx4c> Troubleshooting </a> </li><li data-astro-cid-mb6pvx4c> <a href="/reference" class="header__mobile-nav-link" data-astro-cid-mb6pvx4c> Reference </a> </li> </ul> </nav> </header>  <script type="module">const r=document.getElementById("theme-toggle");r&&r.addEventListener("click",()=>{const e=document.documentElement,t=e.getAttribute("data-theme")==="dark"?"light":"dark";e.setAttribute("data-theme",t);const c=localStorage.getItem("agentcore-initiative-progress");let i={theme:t};if(c)try{i={...JSON.parse(c),theme:t}}catch{}localStorage.setItem("agentcore-initiative-progress",JSON.stringify(i))});const n=document.getElementById("mobile-menu-toggle"),l=document.getElementById("mobile-nav");n&&l&&n.addEventListener("click",()=>{const e=n.getAttribute("aria-expanded")==="true";n.setAttribute("aria-expanded",String(!e)),l.hidden=e;const o=n.querySelector(".menu-icon"),t=n.querySelector(".close-icon");o&&t&&(o.style.display=e?"block":"none",t.style.display=e?"none":"block")});</script> <div class="day-layout" style="--day-accent: #ef4444" data-astro-cid-vfeiczyy> <!-- Sidebar --> <aside class="day-layout__sidebar hide-mobile" data-astro-cid-vfeiczyy> <div class="day-layout__sidebar-content" data-astro-cid-vfeiczyy> <!-- Day Header --> <div class="day-layout__day-header" data-astro-cid-vfeiczyy> <span class="day-layout__day-number" data-astro-cid-vfeiczyy>Day 2</span> <h2 class="day-layout__day-title" data-astro-cid-vfeiczyy>Age of Ultron</h2> <p class="day-layout__day-focus" data-astro-cid-vfeiczyy>Identity + AgentCore Gateway</p> </div> <!-- Section Navigation --> <nav class="day-layout__nav" aria-label="Day sections" data-astro-cid-vfeiczyy> <ul class="day-layout__nav-list" data-astro-cid-vfeiczyy> <li data-astro-cid-vfeiczyy> <a href="/days/2/identity-basics" class="day-layout__nav-link" data-section="identity-basics" data-astro-cid-vfeiczyy> <span class="day-layout__nav-check" aria-hidden="true" data-astro-cid-vfeiczyy> <svg viewBox="0 0 16 16" fill="none" data-astro-cid-vfeiczyy> <circle cx="8" cy="8" r="7" stroke="currentColor" stroke-width="1.5" data-astro-cid-vfeiczyy></circle> <path class="check-mark" d="M5 8l2 2 4-4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" data-astro-cid-vfeiczyy></path> </svg> </span> Identity Basics </a> </li><li data-astro-cid-vfeiczyy> <a href="/days/2/agentcore-gateway" class="day-layout__nav-link" data-section="agentcore-gateway" data-astro-cid-vfeiczyy> <span class="day-layout__nav-check" aria-hidden="true" data-astro-cid-vfeiczyy> <svg viewBox="0 0 16 16" fill="none" data-astro-cid-vfeiczyy> <circle cx="8" cy="8" r="7" stroke="currentColor" stroke-width="1.5" data-astro-cid-vfeiczyy></circle> <path class="check-mark" d="M5 8l2 2 4-4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" data-astro-cid-vfeiczyy></path> </svg> </span> AgentCore Gateway </a> </li><li data-astro-cid-vfeiczyy> <a href="/days/2/multi-tenancy" class="day-layout__nav-link day-layout__nav-link--active" data-section="multi-tenancy" data-astro-cid-vfeiczyy> <span class="day-layout__nav-check" aria-hidden="true" data-astro-cid-vfeiczyy> <svg viewBox="0 0 16 16" fill="none" data-astro-cid-vfeiczyy> <circle cx="8" cy="8" r="7" stroke="currentColor" stroke-width="1.5" data-astro-cid-vfeiczyy></circle> <path class="check-mark" d="M5 8l2 2 4-4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" data-astro-cid-vfeiczyy></path> </svg> </span> Multi-Tenancy </a> </li><li data-astro-cid-vfeiczyy> <a href="/days/2/controlled-disasters" class="day-layout__nav-link" data-section="controlled-disasters" data-astro-cid-vfeiczyy> <span class="day-layout__nav-check" aria-hidden="true" data-astro-cid-vfeiczyy> <svg viewBox="0 0 16 16" fill="none" data-astro-cid-vfeiczyy> <circle cx="8" cy="8" r="7" stroke="currentColor" stroke-width="1.5" data-astro-cid-vfeiczyy></circle> <path class="check-mark" d="M5 8l2 2 4-4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" data-astro-cid-vfeiczyy></path> </svg> </span> Controlled Disasters </a> </li> </ul> </nav> <!-- Challenge Link --> <a href="/days/2/challenge" class="day-layout__challenge-link" data-astro-cid-vfeiczyy> <span class="day-layout__challenge-icon" data-astro-cid-vfeiczyy> <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" data-astro-cid-vfeiczyy> <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" data-astro-cid-vfeiczyy></polygon> </svg> </span>
Daily Challenge
</a> </div> </aside> <!-- Main Content --> <main class="day-layout__main" data-astro-cid-vfeiczyy> <article class="day-layout__content prose" data-astro-cid-vfeiczyy>  <h1 id="multi-tenancy">Multi-Tenancy</h1>
<p>In production, multiple users (or tenants) share your agent infrastructure. <strong>Multi-tenancy</strong> ensures each user can only access their own data - even when using shared tools.</p>
<h2 id="the-multi-tenant-challenge">The Multi-Tenant Challenge</h2>
<p>Consider this scenario:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word" tabindex="0" data-language="plaintext"><code><span class="line"><span>User A: &quot;Show me my GitHub repositories&quot;</span></span>
<span class="line"><span>User B: &quot;Show me my GitHub repositories&quot;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>Without isolation:</span></span>
<span class="line"><span>  → Both users see ALL repositories</span></span>
<span class="line"><span>  → Data leak! Security disaster!</span></span>
<span class="line"><span></span></span>
<span class="line"><span>With isolation:</span></span>
<span class="line"><span>  → User A sees only User A&#39;s repos</span></span>
<span class="line"><span>  → User B sees only User B&#39;s repos</span></span>
<span class="line"><span>  → Properly secured</span></span></code></pre>
<aside class="callout callout--danger" role="note" data-astro-cid-wi7smz4x> <div class="callout__icon" data-astro-cid-wi7smz4x> <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-astro-cid-wi7smz4x> <circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/> </svg> </div> <div class="callout__content" data-astro-cid-wi7smz4x> <p class="callout__title" data-astro-cid-wi7smz4x>Critical Security</p> <div class="callout__body" data-astro-cid-wi7smz4x> <p>Multi-tenant isolation isn’t optional for production agents.
A single data leak can destroy user trust and violate compliance requirements.</p> </div> </div> </aside> 
<h2 id="gateway-interceptors">Gateway Interceptors</h2>
<p>AgentCore Gateway provides <strong>interceptors</strong> - Lambda functions that run before and after tool invocations:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word" tabindex="0" data-language="plaintext"><code><span class="line"><span>┌────────────────────────────────────────────────────────────────────┐</span></span>
<span class="line"><span>│                        Tool Invocation Flow                         │</span></span>
<span class="line"><span>│                                                                     │</span></span>
<span class="line"><span>│  Agent Request                                                      │</span></span>
<span class="line"><span>│       │                                                             │</span></span>
<span class="line"><span>│       ▼                                                             │</span></span>
<span class="line"><span>│  ┌─────────────────────────────────────────┐                       │</span></span>
<span class="line"><span>│  │         REQUEST INTERCEPTOR              │                       │</span></span>
<span class="line"><span>│  │  • Validate tenant ID                    │                       │</span></span>
<span class="line"><span>│  │  • Filter available tools                │                       │</span></span>
<span class="line"><span>│  │  • Inject tenant context                 │                       │</span></span>
<span class="line"><span>│  │  • Transform request                     │                       │</span></span>
<span class="line"><span>│  └─────────────────────────────────────────┘                       │</span></span>
<span class="line"><span>│       │                                                             │</span></span>
<span class="line"><span>│       ▼                                                             │</span></span>
<span class="line"><span>│  ┌─────────────────────────────────────────┐                       │</span></span>
<span class="line"><span>│  │           GATEWAY TARGET                 │                       │</span></span>
<span class="line"><span>│  │         (API / Lambda / MCP)             │                       │</span></span>
<span class="line"><span>│  └─────────────────────────────────────────┘                       │</span></span>
<span class="line"><span>│       │                                                             │</span></span>
<span class="line"><span>│       ▼                                                             │</span></span>
<span class="line"><span>│  ┌─────────────────────────────────────────┐                       │</span></span>
<span class="line"><span>│  │         RESPONSE INTERCEPTOR             │                       │</span></span>
<span class="line"><span>│  │  • Filter response data                  │                       │</span></span>
<span class="line"><span>│  │  • Redact sensitive fields               │                       │</span></span>
<span class="line"><span>│  │  • Audit logging                         │                       │</span></span>
<span class="line"><span>│  └─────────────────────────────────────────┘                       │</span></span>
<span class="line"><span>│       │                                                             │</span></span>
<span class="line"><span>│       ▼                                                             │</span></span>
<span class="line"><span>│  Agent Response                                                     │</span></span>
<span class="line"><span>└────────────────────────────────────────────────────────────────────┘</span></span></code></pre>
<h2 id="implementing-tenant-isolation">Implementing Tenant Isolation</h2>
<h3 id="step-1-create-request-interceptor">Step 1: Create Request Interceptor</h3>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word" tabindex="0" data-language="python"><code><span class="line"><span style="color:#6A737D"># lambda/request_interceptor.py</span></span>
<span class="line"><span style="color:#F97583">import</span><span style="color:#E1E4E8"> json</span></span>
<span class="line"><span style="color:#F97583">import</span><span style="color:#E1E4E8"> logging</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">logger </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> logging.getLogger()</span></span>
<span class="line"><span style="color:#E1E4E8">logger.setLevel(logging.</span><span style="color:#79B8FF">INFO</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">def</span><span style="color:#B392F0"> handler</span><span style="color:#E1E4E8">(event, context):</span></span>
<span class="line"><span style="color:#9ECBFF">    &quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#9ECBFF">    Request interceptor for tenant isolation.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF">    This function runs BEFORE every tool invocation through Gateway.</span></span>
<span class="line"><span style="color:#9ECBFF">    &quot;&quot;&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Extract request details</span></span>
<span class="line"><span style="color:#E1E4E8">    tool_name </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> event.get(</span><span style="color:#9ECBFF">&#39;toolName&#39;</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    tool_input </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> event.get(</span><span style="color:#9ECBFF">&#39;toolInput&#39;</span><span style="color:#E1E4E8">, {})</span></span>
<span class="line"><span style="color:#E1E4E8">    headers </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> event.get(</span><span style="color:#9ECBFF">&#39;headers&#39;</span><span style="color:#E1E4E8">, {})</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Extract tenant context from JWT claims</span></span>
<span class="line"><span style="color:#E1E4E8">    user_context </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> event.get(</span><span style="color:#9ECBFF">&#39;userContext&#39;</span><span style="color:#E1E4E8">, {})</span></span>
<span class="line"><span style="color:#E1E4E8">    tenant_id </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> user_context.get(</span><span style="color:#9ECBFF">&#39;custom:tenant_id&#39;</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    user_id </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> user_context.get(</span><span style="color:#9ECBFF">&#39;sub&#39;</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    logger.info(</span><span style="color:#F97583">f</span><span style="color:#9ECBFF">&quot;Request interceptor: tool=</span><span style="color:#79B8FF">{</span><span style="color:#E1E4E8">tool_name</span><span style="color:#79B8FF">}</span><span style="color:#9ECBFF">, tenant=</span><span style="color:#79B8FF">{</span><span style="color:#E1E4E8">tenant_id</span><span style="color:#79B8FF">}</span><span style="color:#9ECBFF">, user=</span><span style="color:#79B8FF">{</span><span style="color:#E1E4E8">user_id</span><span style="color:#79B8FF">}</span><span style="color:#9ECBFF">&quot;</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Validate tenant exists</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#F97583"> not</span><span style="color:#E1E4E8"> tenant_id:</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#9ECBFF">            &#39;statusCode&#39;</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">403</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">            &#39;error&#39;</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">&#39;TENANT_REQUIRED&#39;</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">            &#39;message&#39;</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">&#39;Tenant ID is required for this operation&#39;</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Inject tenant context into the request</span></span>
<span class="line"><span style="color:#E1E4E8">    modified_input </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">        **</span><span style="color:#E1E4E8">tool_input,</span></span>
<span class="line"><span style="color:#9ECBFF">        &#39;_tenant_context&#39;</span><span style="color:#E1E4E8">: {</span></span>
<span class="line"><span style="color:#9ECBFF">            &#39;tenant_id&#39;</span><span style="color:#E1E4E8">: tenant_id,</span></span>
<span class="line"><span style="color:#9ECBFF">            &#39;user_id&#39;</span><span style="color:#E1E4E8">: user_id,</span></span>
<span class="line"><span style="color:#9ECBFF">            &#39;request_id&#39;</span><span style="color:#E1E4E8">: context.aws_request_id</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Add tenant header for downstream services</span></span>
<span class="line"><span style="color:#E1E4E8">    modified_headers </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">        **</span><span style="color:#E1E4E8">headers,</span></span>
<span class="line"><span style="color:#9ECBFF">        &#39;X-Tenant-ID&#39;</span><span style="color:#E1E4E8">: tenant_id,</span></span>
<span class="line"><span style="color:#9ECBFF">        &#39;X-User-ID&#39;</span><span style="color:#E1E4E8">: user_id</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#9ECBFF">        &#39;statusCode&#39;</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">200</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        &#39;toolInput&#39;</span><span style="color:#E1E4E8">: modified_input,</span></span>
<span class="line"><span style="color:#9ECBFF">        &#39;headers&#39;</span><span style="color:#E1E4E8">: modified_headers,</span></span>
<span class="line"><span style="color:#9ECBFF">        &#39;continue&#39;</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">True</span><span style="color:#6A737D">  # Proceed to target</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span></code></pre>
<h3 id="step-2-create-response-interceptor">Step 2: Create Response Interceptor</h3>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word" tabindex="0" data-language="python"><code><span class="line"><span style="color:#6A737D"># lambda/response_interceptor.py</span></span>
<span class="line"><span style="color:#F97583">import</span><span style="color:#E1E4E8"> json</span></span>
<span class="line"><span style="color:#F97583">import</span><span style="color:#E1E4E8"> logging</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">logger </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> logging.getLogger()</span></span>
<span class="line"><span style="color:#E1E4E8">logger.setLevel(logging.</span><span style="color:#79B8FF">INFO</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">def</span><span style="color:#B392F0"> handler</span><span style="color:#E1E4E8">(event, context):</span></span>
<span class="line"><span style="color:#9ECBFF">    &quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#9ECBFF">    Response interceptor for data filtering and auditing.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#9ECBFF">    This function runs AFTER every tool invocation.</span></span>
<span class="line"><span style="color:#9ECBFF">    &quot;&quot;&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    tool_name </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> event.get(</span><span style="color:#9ECBFF">&#39;toolName&#39;</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    tool_output </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> event.get(</span><span style="color:#9ECBFF">&#39;toolOutput&#39;</span><span style="color:#E1E4E8">, {})</span></span>
<span class="line"><span style="color:#E1E4E8">    user_context </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> event.get(</span><span style="color:#9ECBFF">&#39;userContext&#39;</span><span style="color:#E1E4E8">, {})</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    tenant_id </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> user_context.get(</span><span style="color:#9ECBFF">&#39;custom:tenant_id&#39;</span><span style="color:#E1E4E8">)</span></span>
<span class="line"><span style="color:#E1E4E8">    user_id </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> user_context.get(</span><span style="color:#9ECBFF">&#39;sub&#39;</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Filter response based on tenant</span></span>
<span class="line"><span style="color:#E1E4E8">    filtered_output </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> filter_response_for_tenant(</span></span>
<span class="line"><span style="color:#E1E4E8">        tool_output,</span></span>
<span class="line"><span style="color:#E1E4E8">        tenant_id</span></span>
<span class="line"><span style="color:#E1E4E8">    )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Redact sensitive fields</span></span>
<span class="line"><span style="color:#E1E4E8">    redacted_output </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> redact_sensitive_data(filtered_output)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Audit logging</span></span>
<span class="line"><span style="color:#E1E4E8">    logger.info(json.dumps({</span></span>
<span class="line"><span style="color:#9ECBFF">        &#39;event&#39;</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">&#39;TOOL_INVOCATION&#39;</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        &#39;tool&#39;</span><span style="color:#E1E4E8">: tool_name,</span></span>
<span class="line"><span style="color:#9ECBFF">        &#39;tenant_id&#39;</span><span style="color:#E1E4E8">: tenant_id,</span></span>
<span class="line"><span style="color:#9ECBFF">        &#39;user_id&#39;</span><span style="color:#E1E4E8">: user_id,</span></span>
<span class="line"><span style="color:#9ECBFF">        &#39;request_id&#39;</span><span style="color:#E1E4E8">: context.aws_request_id,</span></span>
<span class="line"><span style="color:#9ECBFF">        &#39;success&#39;</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">True</span></span>
<span class="line"><span style="color:#E1E4E8">    }))</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#9ECBFF">        &#39;statusCode&#39;</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">200</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        &#39;toolOutput&#39;</span><span style="color:#E1E4E8">: redacted_output</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">def</span><span style="color:#B392F0"> filter_response_for_tenant</span><span style="color:#E1E4E8">(data, tenant_id):</span></span>
<span class="line"><span style="color:#9ECBFF">    &quot;&quot;&quot;Filter response to only include tenant&#39;s data.&quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#79B8FF"> isinstance</span><span style="color:#E1E4E8">(data, </span><span style="color:#79B8FF">list</span><span style="color:#E1E4E8">):</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#E1E4E8"> [</span></span>
<span class="line"><span style="color:#E1E4E8">            item </span><span style="color:#F97583">for</span><span style="color:#E1E4E8"> item </span><span style="color:#F97583">in</span><span style="color:#E1E4E8"> data</span></span>
<span class="line"><span style="color:#F97583">            if</span><span style="color:#E1E4E8"> item.get(</span><span style="color:#9ECBFF">&#39;tenant_id&#39;</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">==</span><span style="color:#E1E4E8"> tenant_id </span><span style="color:#F97583">or</span><span style="color:#9ECBFF"> &#39;tenant_id&#39;</span><span style="color:#F97583"> not</span><span style="color:#F97583"> in</span><span style="color:#E1E4E8"> item</span></span>
<span class="line"><span style="color:#E1E4E8">        ]</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> data</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">def</span><span style="color:#B392F0"> redact_sensitive_data</span><span style="color:#E1E4E8">(data):</span></span>
<span class="line"><span style="color:#9ECBFF">    &quot;&quot;&quot;Redact sensitive fields from response.&quot;&quot;&quot;</span></span>
<span class="line"><span style="color:#E1E4E8">    sensitive_fields </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> [</span><span style="color:#9ECBFF">&#39;password&#39;</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">&#39;secret&#39;</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">&#39;token&#39;</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">&#39;api_key&#39;</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">&#39;ssn&#39;</span><span style="color:#E1E4E8">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#79B8FF"> isinstance</span><span style="color:#E1E4E8">(data, </span><span style="color:#79B8FF">dict</span><span style="color:#E1E4E8">):</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#E1E4E8">            k: </span><span style="color:#9ECBFF">&#39;[REDACTED]&#39;</span><span style="color:#F97583"> if</span><span style="color:#E1E4E8"> k.lower() </span><span style="color:#F97583">in</span><span style="color:#E1E4E8"> sensitive_fields </span><span style="color:#F97583">else</span><span style="color:#E1E4E8"> redact_sensitive_data(v)</span></span>
<span class="line"><span style="color:#F97583">            for</span><span style="color:#E1E4E8"> k, v </span><span style="color:#F97583">in</span><span style="color:#E1E4E8"> data.items()</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"><span style="color:#F97583">    elif</span><span style="color:#79B8FF"> isinstance</span><span style="color:#E1E4E8">(data, </span><span style="color:#79B8FF">list</span><span style="color:#E1E4E8">):</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#E1E4E8"> [redact_sensitive_data(item) </span><span style="color:#F97583">for</span><span style="color:#E1E4E8"> item </span><span style="color:#F97583">in</span><span style="color:#E1E4E8"> data]</span></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> data</span></span></code></pre>
<h3 id="step-3-attach-interceptors-to-gateway">Step 3: Attach Interceptors to Gateway</h3>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word" tabindex="0" data-language="python"><code><span class="line"><span style="color:#F97583">import</span><span style="color:#E1E4E8"> boto3</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">gateway_client </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> boto3.client(</span><span style="color:#9ECBFF">&#39;bedrock-agentcore-gateway&#39;</span><span style="color:#E1E4E8">, </span><span style="color:#FFAB70">region_name</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">&#39;us-east-1&#39;</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># Update gateway with interceptors</span></span>
<span class="line"><span style="color:#E1E4E8">gateway_client.update_gateway(</span></span>
<span class="line"><span style="color:#FFAB70">    gatewayId</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">&#39;gw-xxxx&#39;</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#FFAB70">    requestInterceptor</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">{</span></span>
<span class="line"><span style="color:#9ECBFF">        &#39;lambdaArn&#39;</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">&#39;arn:aws:lambda:us-east-1:123456789012:function:request-interceptor&#39;</span></span>
<span class="line"><span style="color:#E1E4E8">    },</span></span>
<span class="line"><span style="color:#FFAB70">    responseInterceptor</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">{</span></span>
<span class="line"><span style="color:#9ECBFF">        &#39;lambdaArn&#39;</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">&#39;arn:aws:lambda:us-east-1:123456789012:function:response-interceptor&#39;</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"><span style="color:#E1E4E8">)</span></span></code></pre>
<h2 id="dynamic-tool-filtering">Dynamic Tool Filtering</h2>
<p>Interceptors can filter which tools are available to each user:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word" tabindex="0" data-language="python"><code><span class="line"><span style="color:#6A737D"># lambda/request_interceptor.py (extended)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D"># Tool permissions by role</span></span>
<span class="line"><span style="color:#79B8FF">TOOL_PERMISSIONS</span><span style="color:#F97583"> =</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#9ECBFF">    &#39;admin&#39;</span><span style="color:#E1E4E8">: [</span><span style="color:#9ECBFF">&#39;*&#39;</span><span style="color:#E1E4E8">],  </span><span style="color:#6A737D"># All tools</span></span>
<span class="line"><span style="color:#9ECBFF">    &#39;developer&#39;</span><span style="color:#E1E4E8">: [</span><span style="color:#9ECBFF">&#39;search_code&#39;</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">&#39;create_branch&#39;</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">&#39;view_commits&#39;</span><span style="color:#E1E4E8">],</span></span>
<span class="line"><span style="color:#9ECBFF">    &#39;viewer&#39;</span><span style="color:#E1E4E8">: [</span><span style="color:#9ECBFF">&#39;search_code&#39;</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">&#39;view_commits&#39;</span><span style="color:#E1E4E8">],</span></span>
<span class="line"><span style="color:#E1E4E8">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">def</span><span style="color:#B392F0"> filter_tools_for_user</span><span style="color:#E1E4E8">(event, context):</span></span>
<span class="line"><span style="color:#9ECBFF">    &quot;&quot;&quot;Filter available tools based on user role.&quot;&quot;&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    user_context </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> event.get(</span><span style="color:#9ECBFF">&#39;userContext&#39;</span><span style="color:#E1E4E8">, {})</span></span>
<span class="line"><span style="color:#E1E4E8">    user_role </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> user_context.get(</span><span style="color:#9ECBFF">&#39;custom:role&#39;</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">&#39;viewer&#39;</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Get allowed tools for this role</span></span>
<span class="line"><span style="color:#E1E4E8">    allowed_tools </span><span style="color:#F97583">=</span><span style="color:#79B8FF"> TOOL_PERMISSIONS</span><span style="color:#E1E4E8">.get(user_role, [])</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#E1E4E8"> event.get(</span><span style="color:#9ECBFF">&#39;operation&#39;</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">==</span><span style="color:#9ECBFF"> &#39;list_tools&#39;</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#6A737D">        # Filter tool list</span></span>
<span class="line"><span style="color:#E1E4E8">        all_tools </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> event.get(</span><span style="color:#9ECBFF">&#39;tools&#39;</span><span style="color:#E1E4E8">, [])</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">        if</span><span style="color:#9ECBFF"> &#39;*&#39;</span><span style="color:#F97583"> in</span><span style="color:#E1E4E8"> allowed_tools:</span></span>
<span class="line"><span style="color:#E1E4E8">            filtered_tools </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> all_tools</span></span>
<span class="line"><span style="color:#F97583">        else</span><span style="color:#E1E4E8">:</span></span>
<span class="line"><span style="color:#E1E4E8">            filtered_tools </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> [</span></span>
<span class="line"><span style="color:#E1E4E8">                t </span><span style="color:#F97583">for</span><span style="color:#E1E4E8"> t </span><span style="color:#F97583">in</span><span style="color:#E1E4E8"> all_tools</span></span>
<span class="line"><span style="color:#F97583">                if</span><span style="color:#E1E4E8"> t[</span><span style="color:#9ECBFF">&#39;name&#39;</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">in</span><span style="color:#E1E4E8"> allowed_tools</span></span>
<span class="line"><span style="color:#E1E4E8">            ]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#9ECBFF">            &#39;statusCode&#39;</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">200</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">            &#39;tools&#39;</span><span style="color:#E1E4E8">: filtered_tools</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # For tool invocation, verify permission</span></span>
<span class="line"><span style="color:#E1E4E8">    tool_name </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> event.get(</span><span style="color:#9ECBFF">&#39;toolName&#39;</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    if</span><span style="color:#9ECBFF"> &#39;*&#39;</span><span style="color:#F97583"> not</span><span style="color:#F97583"> in</span><span style="color:#E1E4E8"> allowed_tools </span><span style="color:#F97583">and</span><span style="color:#E1E4E8"> tool_name </span><span style="color:#F97583">not</span><span style="color:#F97583"> in</span><span style="color:#E1E4E8"> allowed_tools:</span></span>
<span class="line"><span style="color:#F97583">        return</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#9ECBFF">            &#39;statusCode&#39;</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">403</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">            &#39;error&#39;</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">&#39;TOOL_NOT_PERMITTED&#39;</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">            &#39;message&#39;</span><span style="color:#E1E4E8">: </span><span style="color:#F97583">f</span><span style="color:#9ECBFF">&#39;User role &quot;</span><span style="color:#79B8FF">{</span><span style="color:#E1E4E8">user_role</span><span style="color:#79B8FF">}</span><span style="color:#9ECBFF">&quot; cannot access tool &quot;</span><span style="color:#79B8FF">{</span><span style="color:#E1E4E8">tool_name</span><span style="color:#79B8FF">}</span><span style="color:#9ECBFF">&quot;&#39;</span></span>
<span class="line"><span style="color:#E1E4E8">        }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> {</span><span style="color:#9ECBFF">&#39;statusCode&#39;</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">200</span><span style="color:#E1E4E8">, </span><span style="color:#9ECBFF">&#39;continue&#39;</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">True</span><span style="color:#E1E4E8">}</span></span></code></pre>
<aside class="callout callout--tip" role="note" data-astro-cid-wi7smz4x> <div class="callout__icon" data-astro-cid-wi7smz4x> <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-astro-cid-wi7smz4x> <path d="M15 14c.2-1 .7-1.7 1.5-2.5 1-.9 1.5-2.2 1.5-3.5A6 6 0 0 0 6 8c0 1 .2 2.2 1.5 3.5.7.7 1.3 1.5 1.5 2.5"/><path d="M9 18h6"/><path d="M10 22h4"/> </svg> </div> <div class="callout__content" data-astro-cid-wi7smz4x> <p class="callout__title" data-astro-cid-wi7smz4x>Fine-Grained Access</p> <div class="callout__body" data-astro-cid-wi7smz4x> <p>Interceptors enable sophisticated access control:</p><ul>
<li>Role-based tool filtering</li>
<li>Time-based access restrictions</li>
<li>Resource-level permissions</li>
<li>Dynamic policy evaluation</li>
</ul> </div> </div> </aside> 
<h2 id="identity-propagation">Identity Propagation</h2>
<p>When tools call other services, maintain the identity chain:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word" tabindex="0" data-language="python"><code><span class="line"><span style="color:#6A737D"># In your request interceptor</span></span>
<span class="line"><span style="color:#F97583">def</span><span style="color:#B392F0"> propagate_identity</span><span style="color:#E1E4E8">(event, context):</span></span>
<span class="line"><span style="color:#9ECBFF">    &quot;&quot;&quot;Propagate user identity through the tool chain.&quot;&quot;&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">    user_context </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> event.get(</span><span style="color:#9ECBFF">&#39;userContext&#39;</span><span style="color:#E1E4E8">, {})</span></span>
<span class="line"><span style="color:#E1E4E8">    headers </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> event.get(</span><span style="color:#9ECBFF">&#39;headers&#39;</span><span style="color:#E1E4E8">, {})</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">    # Create an &quot;act on behalf of&quot; token</span></span>
<span class="line"><span style="color:#6A737D">    # This allows downstream services to know who the original user is</span></span>
<span class="line"><span style="color:#E1E4E8">    act_as_headers </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#F97583">        **</span><span style="color:#E1E4E8">headers,</span></span>
<span class="line"><span style="color:#9ECBFF">        &#39;X-Original-User&#39;</span><span style="color:#E1E4E8">: user_context.get(</span><span style="color:#9ECBFF">&#39;sub&#39;</span><span style="color:#E1E4E8">),</span></span>
<span class="line"><span style="color:#9ECBFF">        &#39;X-Original-Tenant&#39;</span><span style="color:#E1E4E8">: user_context.get(</span><span style="color:#9ECBFF">&#39;custom:tenant_id&#39;</span><span style="color:#E1E4E8">),</span></span>
<span class="line"><span style="color:#9ECBFF">        &#39;X-Agent-ID&#39;</span><span style="color:#E1E4E8">: event.get(</span><span style="color:#9ECBFF">&#39;agentId&#39;</span><span style="color:#E1E4E8">),</span></span>
<span class="line"><span style="color:#9ECBFF">        &#39;X-Trace-ID&#39;</span><span style="color:#E1E4E8">: context.aws_request_id</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    return</span><span style="color:#E1E4E8"> {</span></span>
<span class="line"><span style="color:#9ECBFF">        &#39;statusCode&#39;</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">200</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#9ECBFF">        &#39;headers&#39;</span><span style="color:#E1E4E8">: act_as_headers,</span></span>
<span class="line"><span style="color:#9ECBFF">        &#39;continue&#39;</span><span style="color:#E1E4E8">: </span><span style="color:#79B8FF">True</span></span>
<span class="line"><span style="color:#E1E4E8">    }</span></span></code></pre>
<h2 id="testing-multi-tenant-isolation">Testing Multi-Tenant Isolation</h2>
<p>Create a test suite to verify isolation:</p>
<pre class="astro-code github-dark" style="background-color:#24292e;color:#e1e4e8;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word" tabindex="0" data-language="python"><code><span class="line"><span style="color:#6A737D"># test_multi_tenancy.py</span></span>
<span class="line"><span style="color:#F97583">import</span><span style="color:#E1E4E8"> pytest</span></span>
<span class="line"><span style="color:#F97583">import</span><span style="color:#E1E4E8"> boto3</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8">gateway_client </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> boto3.client(</span><span style="color:#9ECBFF">&#39;bedrock-agentcore-gateway&#39;</span><span style="color:#E1E4E8">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">class</span><span style="color:#B392F0"> TestMultiTenantIsolation</span><span style="color:#E1E4E8">:</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    def</span><span style="color:#B392F0"> test_tenant_a_cannot_see_tenant_b_data</span><span style="color:#E1E4E8">(self):</span></span>
<span class="line"><span style="color:#9ECBFF">        &quot;&quot;&quot;Verify data isolation between tenants.&quot;&quot;&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">        # Invoke as Tenant A</span></span>
<span class="line"><span style="color:#E1E4E8">        response_a </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> gateway_client.invoke_tool(</span></span>
<span class="line"><span style="color:#FFAB70">            gatewayId</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">&#39;gw-xxxx&#39;</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#FFAB70">            toolName</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">&#39;list_documents&#39;</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#FFAB70">            toolInput</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">{},</span></span>
<span class="line"><span style="color:#FFAB70">            authContext</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">{</span><span style="color:#9ECBFF">&#39;tenant_id&#39;</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">&#39;tenant-a&#39;</span><span style="color:#E1E4E8">}</span></span>
<span class="line"><span style="color:#E1E4E8">        )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">        # Invoke as Tenant B</span></span>
<span class="line"><span style="color:#E1E4E8">        response_b </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> gateway_client.invoke_tool(</span></span>
<span class="line"><span style="color:#FFAB70">            gatewayId</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">&#39;gw-xxxx&#39;</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#FFAB70">            toolName</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">&#39;list_documents&#39;</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#FFAB70">            toolInput</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">{},</span></span>
<span class="line"><span style="color:#FFAB70">            authContext</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">{</span><span style="color:#9ECBFF">&#39;tenant_id&#39;</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">&#39;tenant-b&#39;</span><span style="color:#E1E4E8">}</span></span>
<span class="line"><span style="color:#E1E4E8">        )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">        # Verify isolation</span></span>
<span class="line"><span style="color:#E1E4E8">        docs_a </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> response_a[</span><span style="color:#9ECBFF">&#39;result&#39;</span><span style="color:#E1E4E8">][</span><span style="color:#9ECBFF">&#39;documents&#39;</span><span style="color:#E1E4E8">]</span></span>
<span class="line"><span style="color:#E1E4E8">        docs_b </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> response_b[</span><span style="color:#9ECBFF">&#39;result&#39;</span><span style="color:#E1E4E8">][</span><span style="color:#9ECBFF">&#39;documents&#39;</span><span style="color:#E1E4E8">]</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">        # No overlap should exist</span></span>
<span class="line"><span style="color:#E1E4E8">        ids_a </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> {d[</span><span style="color:#9ECBFF">&#39;id&#39;</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">for</span><span style="color:#E1E4E8"> d </span><span style="color:#F97583">in</span><span style="color:#E1E4E8"> docs_a}</span></span>
<span class="line"><span style="color:#E1E4E8">        ids_b </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> {d[</span><span style="color:#9ECBFF">&#39;id&#39;</span><span style="color:#E1E4E8">] </span><span style="color:#F97583">for</span><span style="color:#E1E4E8"> d </span><span style="color:#F97583">in</span><span style="color:#E1E4E8"> docs_b}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">        assert</span><span style="color:#E1E4E8"> ids_a.isdisjoint(ids_b), </span><span style="color:#9ECBFF">&quot;Data leak detected!&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    def</span><span style="color:#B392F0"> test_tool_filtering_by_role</span><span style="color:#E1E4E8">(self):</span></span>
<span class="line"><span style="color:#9ECBFF">        &quot;&quot;&quot;Verify tools are filtered based on user role.&quot;&quot;&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">        # List tools as admin</span></span>
<span class="line"><span style="color:#E1E4E8">        admin_tools </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> gateway_client.list_tools(</span></span>
<span class="line"><span style="color:#FFAB70">            gatewayId</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">&#39;gw-xxxx&#39;</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#FFAB70">            authContext</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">{</span><span style="color:#9ECBFF">&#39;role&#39;</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">&#39;admin&#39;</span><span style="color:#E1E4E8">}</span></span>
<span class="line"><span style="color:#E1E4E8">        )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6A737D">        # List tools as viewer</span></span>
<span class="line"><span style="color:#E1E4E8">        viewer_tools </span><span style="color:#F97583">=</span><span style="color:#E1E4E8"> gateway_client.list_tools(</span></span>
<span class="line"><span style="color:#FFAB70">            gatewayId</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">&#39;gw-xxxx&#39;</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#FFAB70">            authContext</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">{</span><span style="color:#9ECBFF">&#39;role&#39;</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">&#39;viewer&#39;</span><span style="color:#E1E4E8">}</span></span>
<span class="line"><span style="color:#E1E4E8">        )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">        assert</span><span style="color:#79B8FF"> len</span><span style="color:#E1E4E8">(admin_tools[</span><span style="color:#9ECBFF">&#39;tools&#39;</span><span style="color:#E1E4E8">]) </span><span style="color:#F97583">&gt;</span><span style="color:#79B8FF"> len</span><span style="color:#E1E4E8">(viewer_tools[</span><span style="color:#9ECBFF">&#39;tools&#39;</span><span style="color:#E1E4E8">])</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">    def</span><span style="color:#B392F0"> test_unauthorized_tool_access_blocked</span><span style="color:#E1E4E8">(self):</span></span>
<span class="line"><span style="color:#9ECBFF">        &quot;&quot;&quot;Verify viewers cannot access admin tools.&quot;&quot;&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">        with</span><span style="color:#E1E4E8"> pytest.raises(</span><span style="color:#79B8FF">Exception</span><span style="color:#E1E4E8">) </span><span style="color:#F97583">as</span><span style="color:#E1E4E8"> exc_info:</span></span>
<span class="line"><span style="color:#E1E4E8">            gateway_client.invoke_tool(</span></span>
<span class="line"><span style="color:#FFAB70">                gatewayId</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">&#39;gw-xxxx&#39;</span><span style="color:#E1E4E8">,</span></span>
<span class="line"><span style="color:#FFAB70">                toolName</span><span style="color:#F97583">=</span><span style="color:#9ECBFF">&#39;delete_all_data&#39;</span><span style="color:#E1E4E8">,  </span><span style="color:#6A737D"># Admin-only tool</span></span>
<span class="line"><span style="color:#FFAB70">                toolInput</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">{},</span></span>
<span class="line"><span style="color:#FFAB70">                authContext</span><span style="color:#F97583">=</span><span style="color:#E1E4E8">{</span><span style="color:#9ECBFF">&#39;role&#39;</span><span style="color:#E1E4E8">: </span><span style="color:#9ECBFF">&#39;viewer&#39;</span><span style="color:#E1E4E8">}</span></span>
<span class="line"><span style="color:#E1E4E8">            )</span></span>
<span class="line"></span>
<span class="line"><span style="color:#F97583">        assert</span><span style="color:#9ECBFF"> &#39;TOOL_NOT_PERMITTED&#39;</span><span style="color:#F97583"> in</span><span style="color:#79B8FF"> str</span><span style="color:#E1E4E8">(exc_info.value)</span></span></code></pre>
<h2 id="checkpoint">Checkpoint</h2>
<p>You’ve learned:</p>
<ul>
<li>✅ Why multi-tenant isolation is critical</li>
<li>✅ How Gateway interceptors work</li>
<li>✅ Implementing request and response interceptors</li>
<li>✅ Dynamic tool filtering by user role</li>
<li>✅ Identity propagation through tool chains</li>
<li>✅ Testing isolation</li>
</ul>
<p><strong>Next, we’ll experience what happens without these protections.</strong></p>
<div class="nav-buttons"><a href="/days/2/agentcore-gateway" class="nav-button nav-button--prev"><p>← AgentCore Gateway</p></a><a href="/days/2/controlled-disasters" class="nav-button nav-button--next"><p>Next: Controlled Disasters →</p></a></div>
<style>
.nav-buttons {
  display: flex;
  justify-content: space-between;
  margin-top: 3rem;
  gap: 1rem;
}

.nav-button {
  padding: 0.75rem 1.5rem;
  font-weight: 500;
  text-decoration: none;
  border-radius: var(--radius-md);
  transition: all 0.2s ease;
}

.nav-button--prev {
  color: var(--color-text-secondary);
  background: var(--color-bg-elevated);
  border: 1px solid var(--border-subtle);
}

.nav-button--prev:hover {
  background: var(--color-bg-secondary);
}

.nav-button--next {
  color: white;
  background: var(--color-day-2);
}

.nav-button--next:hover {
  opacity: 0.9;
}
</style>   </article> <!-- Navigation Footer --> <nav class="day-layout__pagination" aria-label="Page navigation" data-astro-cid-vfeiczyy>  <div class="pagination" data-astro-cid-ucfvjs2v> <a href="/days/2/agentcore-gateway" class="pagination__link pagination__link--prev" data-astro-cid-ucfvjs2v> <span class="pagination__label" data-astro-cid-ucfvjs2v>Previous</span> <span class="pagination__title" data-astro-cid-ucfvjs2v>AgentCore Gateway</span> </a> <a href="/days/2/controlled-disasters" class="pagination__link pagination__link--next" data-astro-cid-ucfvjs2v> <span class="pagination__label" data-astro-cid-ucfvjs2v>Next</span> <span class="pagination__title" data-astro-cid-ucfvjs2v>Controlled Disasters</span> </a> </div>  </nav> </main> <!-- Table of Contents --> <aside class="day-layout__toc hide-mobile" data-astro-cid-vfeiczyy> <div class="day-layout__toc-content" data-astro-cid-vfeiczyy> <h3 class="day-layout__toc-title" data-astro-cid-vfeiczyy>On this page</h3> <nav aria-label="Table of contents" data-astro-cid-vfeiczyy> <ul class="day-layout__toc-list" data-astro-cid-vfeiczyy> <li data-astro-cid-vfeiczyy> <a href="#the-multi-tenant-challenge" class="day-layout__toc-link" data-astro-cid-vfeiczyy> The Multi-Tenant Challenge </a> </li><li data-astro-cid-vfeiczyy> <a href="#gateway-interceptors" class="day-layout__toc-link" data-astro-cid-vfeiczyy> Gateway Interceptors </a> </li><li data-astro-cid-vfeiczyy> <a href="#implementing-tenant-isolation" class="day-layout__toc-link" data-astro-cid-vfeiczyy> Implementing Tenant Isolation </a> </li><li data-astro-cid-vfeiczyy> <a href="#step-1-create-request-interceptor" class="day-layout__toc-link day-layout__toc-link--nested" data-astro-cid-vfeiczyy> Step 1: Create Request Interceptor </a> </li><li data-astro-cid-vfeiczyy> <a href="#step-2-create-response-interceptor" class="day-layout__toc-link day-layout__toc-link--nested" data-astro-cid-vfeiczyy> Step 2: Create Response Interceptor </a> </li><li data-astro-cid-vfeiczyy> <a href="#step-3-attach-interceptors-to-gateway" class="day-layout__toc-link day-layout__toc-link--nested" data-astro-cid-vfeiczyy> Step 3: Attach Interceptors to Gateway </a> </li><li data-astro-cid-vfeiczyy> <a href="#dynamic-tool-filtering" class="day-layout__toc-link" data-astro-cid-vfeiczyy> Dynamic Tool Filtering </a> </li><li data-astro-cid-vfeiczyy> <a href="#identity-propagation" class="day-layout__toc-link" data-astro-cid-vfeiczyy> Identity Propagation </a> </li><li data-astro-cid-vfeiczyy> <a href="#testing-multi-tenant-isolation" class="day-layout__toc-link" data-astro-cid-vfeiczyy> Testing Multi-Tenant Isolation </a> </li><li data-astro-cid-vfeiczyy> <a href="#checkpoint" class="day-layout__toc-link" data-astro-cid-vfeiczyy> Checkpoint </a> </li> </ul> </nav> </div> </aside> </div> <footer class="footer" data-astro-cid-b2avyow5> <div class="footer__container" data-astro-cid-b2avyow5> <div class="footer__content" data-astro-cid-b2avyow5> <div class="footer__brand" data-astro-cid-b2avyow5> <span class="footer__logo" data-astro-cid-b2avyow5>AgentCore Initiative</span> <p class="footer__tagline" data-astro-cid-b2avyow5>
Build production-ready AI agents with AWS AgentCore
</p> </div> <nav class="footer__nav" aria-label="Footer navigation" data-astro-cid-b2avyow5> <div class="footer__nav-section" data-astro-cid-b2avyow5> <h4 class="footer__nav-title" data-astro-cid-b2avyow5>Course</h4> <ul class="footer__nav-list" data-astro-cid-b2avyow5> <li data-astro-cid-b2avyow5><a href="/days/1" data-astro-cid-b2avyow5>Day 1: The First Avenger</a></li> <li data-astro-cid-b2avyow5><a href="/days/2" data-astro-cid-b2avyow5>Day 2: Age of Ultron</a></li> <li data-astro-cid-b2avyow5><a href="/days/3" data-astro-cid-b2avyow5>Day 3: Infinity War</a></li> <li data-astro-cid-b2avyow5><a href="/days/4" data-astro-cid-b2avyow5>Day 4: Endgame</a></li> <li data-astro-cid-b2avyow5><a href="/days/5" data-astro-cid-b2avyow5>Day 5: Assemble</a></li> </ul> </div> <div class="footer__nav-section" data-astro-cid-b2avyow5> <h4 class="footer__nav-title" data-astro-cid-b2avyow5>Resources</h4> <ul class="footer__nav-list" data-astro-cid-b2avyow5> <li data-astro-cid-b2avyow5><a href="/troubleshooting" data-astro-cid-b2avyow5>Troubleshooting</a></li> <li data-astro-cid-b2avyow5><a href="/reference/costs" data-astro-cid-b2avyow5>Cost Guide</a></li> <li data-astro-cid-b2avyow5><a href="/reference/cleanup" data-astro-cid-b2avyow5>Cleanup</a></li> </ul> </div> <div class="footer__nav-section" data-astro-cid-b2avyow5> <h4 class="footer__nav-title" data-astro-cid-b2avyow5>Links</h4> <ul class="footer__nav-list" data-astro-cid-b2avyow5> <li data-astro-cid-b2avyow5> <a href="https://docs.aws.amazon.com/bedrock-agentcore/" target="_blank" rel="noopener noreferrer" data-astro-cid-b2avyow5>
AWS AgentCore Docs
</a> </li> <li data-astro-cid-b2avyow5> <a href="https://github.com/awslabs/amazon-bedrock-agentcore-samples" target="_blank" rel="noopener noreferrer" data-astro-cid-b2avyow5>
AgentCore Samples
</a> </li> <li data-astro-cid-b2avyow5> <a href="https://strandsagents.com" target="_blank" rel="noopener noreferrer" data-astro-cid-b2avyow5>
Strands Agents
</a> </li> </ul> </div> </nav> </div> <div class="footer__bottom" data-astro-cid-b2avyow5> <p class="footer__copyright" data-astro-cid-b2avyow5>
&copy; 2026 The AgentCore Initiative. Built with Astro.
</p> <p class="footer__disclaimer" data-astro-cid-b2avyow5>
This is an educational resource. AWS and Amazon Bedrock are trademarks of Amazon.com, Inc.
</p> </div> </div> </footer>   <!-- Global scripts --> <script type="module" src="/_astro/BaseLayout.astro_astro_type_script_index_0_lang.BwEjmFOO.js"></script> </body> </html>   <script type="module" src="/_astro/DayLayout.astro_astro_type_script_index_0_lang.BT_UbId1.js"></script> 