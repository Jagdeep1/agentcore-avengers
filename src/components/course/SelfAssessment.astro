---
/**
 * SelfAssessment - Interactive tier-based rubric with progress tracking
 */

interface Requirement {
  id: string;
  text: string;
  tier: 'required' | 'bronze' | 'silver' | 'gold';
  hints?: string[];
}

interface Props {
  dayNumber: number;
  requirements: Requirement[];
}

const { dayNumber, requirements } = Astro.props;

// Group requirements by tier
const tiers = {
  required: requirements.filter((r) => r.tier === 'required'),
  bronze: requirements.filter((r) => r.tier === 'bronze'),
  silver: requirements.filter((r) => r.tier === 'silver'),
  gold: requirements.filter((r) => r.tier === 'gold'),
};

const tierConfig = {
  required: { label: 'Required', color: 'var(--color-text-primary)', icon: 'â—‹' },
  bronze: { label: 'Bronze', color: 'var(--color-tier-bronze)', icon: 'ðŸ¥‰' },
  silver: { label: 'Silver', color: 'var(--color-tier-silver)', icon: 'ðŸ¥ˆ' },
  gold: { label: 'Gold', color: 'var(--color-tier-gold)', icon: 'ðŸ¥‡' },
};
---

<div class="self-assessment" data-day={dayNumber}>
  <!-- Tier Progress Overview -->
  <div class="assessment__progress">
    {Object.entries(tiers).map(([tier, items]) => items.length > 0 && (
      <div
        class="assessment__tier-badge"
        data-tier={tier}
        style={`--tier-color: ${tierConfig[tier as keyof typeof tierConfig].color}`}
      >
        <span class="assessment__tier-icon">{tierConfig[tier as keyof typeof tierConfig].icon}</span>
        <span class="assessment__tier-label">{tierConfig[tier as keyof typeof tierConfig].label}</span>
        <span class="assessment__tier-count">
          <span class="count-completed">0</span>/<span class="count-total">{items.length}</span>
        </span>
      </div>
    ))}
  </div>

  <!-- Requirements by Tier -->
  {Object.entries(tiers).map(([tier, items]) => items.length > 0 && (
    <div
      class="assessment__section"
      data-tier={tier}
      style={`--tier-color: ${tierConfig[tier as keyof typeof tierConfig].color}`}
    >
      <h3 class="assessment__section-title">
        <span class="assessment__section-icon">{tierConfig[tier as keyof typeof tierConfig].icon}</span>
        {tierConfig[tier as keyof typeof tierConfig].label}
        <span class="assessment__section-badge">
          <span class="section-completed">0</span>/{items.length}
        </span>
      </h3>

      <ul class="assessment__list">
        {items.map((req) => (
          <li class="assessment__item" data-id={req.id}>
            <label class="assessment__checkbox">
              <input type="checkbox" name={req.id} />
              <span class="assessment__checkmark">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                  <polyline points="20 6 9 17 4 12" />
                </svg>
              </span>
              <span class="assessment__text">{req.text}</span>
            </label>

            {req.hints && req.hints.length > 0 && (
              <button class="assessment__hints-toggle" type="button" aria-expanded="false">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10" />
                  <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3" />
                  <path d="M12 17h.01" />
                </svg>
                Hints
              </button>
            )}

            {req.hints && req.hints.length > 0 && (
              <ul class="assessment__hints" hidden>
                {req.hints.map((hint) => (
                  <li>{hint}</li>
                ))}
              </ul>
            )}
          </li>
        ))}
      </ul>
    </div>
  ))}

  <!-- Completion Message -->
  <div class="assessment__completion" hidden>
    <div class="assessment__completion-icon">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
        <polyline points="22 4 12 14.01 9 11.01" />
      </svg>
    </div>
    <h3>Day {dayNumber} Complete!</h3>
    <p>You've completed all required items. Day {dayNumber + 1} is now unlocked!</p>
  </div>
</div>

<style>
  .self-assessment {
    --tier-color: var(--color-text-primary);
  }

  .assessment__progress {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    margin-bottom: 2rem;
    padding: 1rem;
    background: var(--color-bg-secondary);
    border-radius: var(--radius-lg);
  }

  .assessment__tier-badge {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: var(--color-bg-primary);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-md);
    font-size: 0.875rem;
  }

  .assessment__tier-badge[data-completed="true"] {
    border-color: var(--tier-color);
    background: color-mix(in srgb, var(--tier-color) 10%, transparent);
  }

  .assessment__tier-icon {
    font-size: 1rem;
  }

  .assessment__tier-label {
    font-weight: 600;
    color: var(--tier-color);
  }

  .assessment__tier-count {
    font-family: var(--font-mono);
    font-size: 0.75rem;
    color: var(--color-text-muted);
  }

  .assessment__section {
    margin-bottom: 2rem;
  }

  .assessment__section-title {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 1rem;
    font-weight: 600;
    color: var(--tier-color);
    margin-bottom: 1rem;
  }

  .assessment__section-icon {
    font-size: 1.25rem;
  }

  .assessment__section-badge {
    margin-left: auto;
    padding: 0.25rem 0.75rem;
    font-family: var(--font-mono);
    font-size: 0.75rem;
    font-weight: 400;
    color: var(--color-text-muted);
    background: var(--color-bg-secondary);
    border-radius: var(--radius-md);
  }

  .assessment__list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .assessment__item {
    padding: 1rem;
    background: var(--color-bg-secondary);
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-lg);
    transition: all 0.2s ease;
  }

  .assessment__item[data-checked="true"] {
    border-color: var(--tier-color);
    background: color-mix(in srgb, var(--tier-color) 5%, var(--color-bg-secondary));
  }

  .assessment__checkbox {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    cursor: pointer;
  }

  .assessment__checkbox input {
    position: absolute;
    opacity: 0;
    width: 0;
    height: 0;
  }

  .assessment__checkmark {
    flex-shrink: 0;
    width: 1.5rem;
    height: 1.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 2px solid var(--border-default);
    border-radius: var(--radius-sm);
    background: var(--color-bg-primary);
    transition: all 0.2s ease;
  }

  .assessment__checkmark svg {
    width: 1rem;
    height: 1rem;
    opacity: 0;
    transform: scale(0.5);
    transition: all 0.2s ease;
    color: white;
  }

  .assessment__checkbox input:checked + .assessment__checkmark {
    background: var(--tier-color);
    border-color: var(--tier-color);
  }

  .assessment__checkbox input:checked + .assessment__checkmark svg {
    opacity: 1;
    transform: scale(1);
  }

  .assessment__checkbox input:focus-visible + .assessment__checkmark {
    outline: 2px solid var(--color-accent-primary);
    outline-offset: 2px;
  }

  .assessment__text {
    flex: 1;
    font-size: 0.9375rem;
    color: var(--color-text-secondary);
    line-height: 1.5;
  }

  .assessment__checkbox input:checked ~ .assessment__text {
    color: var(--color-text-primary);
  }

  .assessment__hints-toggle {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    margin-top: 0.75rem;
    padding: 0.375rem 0.75rem;
    font-size: 0.75rem;
    font-weight: 500;
    color: var(--color-text-muted);
    background: transparent;
    border: 1px solid var(--border-subtle);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .assessment__hints-toggle:hover {
    color: var(--color-text-secondary);
    border-color: var(--border-default);
  }

  .assessment__hints-toggle svg {
    width: 0.875rem;
    height: 0.875rem;
  }

  .assessment__hints {
    margin: 0.75rem 0 0 2.25rem;
    padding: 0.75rem 1rem;
    font-size: 0.8125rem;
    color: var(--color-text-muted);
    background: var(--color-bg-primary);
    border-radius: var(--radius-md);
    list-style: disc;
    padding-left: 2rem;
  }

  .assessment__hints li {
    margin-bottom: 0.25rem;
  }

  .assessment__hints li:last-child {
    margin-bottom: 0;
  }

  .assessment__completion {
    text-align: center;
    padding: 2rem;
    background: linear-gradient(
      135deg,
      rgba(16, 185, 129, 0.1) 0%,
      rgba(16, 185, 129, 0.05) 100%
    );
    border: 1px solid rgba(16, 185, 129, 0.3);
    border-radius: var(--radius-xl);
  }

  .assessment__completion-icon {
    width: 3rem;
    height: 3rem;
    margin: 0 auto 1rem;
    color: var(--color-accent-success);
  }

  .assessment__completion h3 {
    font-size: 1.25rem;
    color: var(--color-accent-success);
    margin-bottom: 0.5rem;
  }

  .assessment__completion p {
    font-size: 0.9375rem;
    color: var(--color-text-secondary);
  }
</style>

<script>
  import { toggleChallengeItem, getChallengeChecks, completeDayChallenge } from '@/lib/progress';

  document.querySelectorAll('.self-assessment').forEach((assessment) => {
    const dayNumber = parseInt(assessment.getAttribute('data-day') || '1');
    const checkedItems = getChallengeChecks(dayNumber);

    // Initialize checkboxes from localStorage
    checkedItems.forEach((id) => {
      const checkbox = assessment.querySelector(`input[name="${id}"]`) as HTMLInputElement;
      if (checkbox) {
        checkbox.checked = true;
        const item = checkbox.closest('.assessment__item');
        if (item) item.setAttribute('data-checked', 'true');
      }
    });

    // Update counts
    updateCounts(assessment, dayNumber);

    // Handle checkbox changes
    assessment.querySelectorAll('input[type="checkbox"]').forEach((checkbox) => {
      checkbox.addEventListener('change', (e) => {
        const input = e.target as HTMLInputElement;
        const id = input.name;
        const item = input.closest('.assessment__item');

        toggleChallengeItem(dayNumber, id);

        if (item) {
          item.setAttribute('data-checked', input.checked ? 'true' : 'false');
        }

        updateCounts(assessment, dayNumber);
        checkCompletion(assessment, dayNumber);
      });
    });

    // Handle hints toggle
    assessment.querySelectorAll('.assessment__hints-toggle').forEach((button) => {
      button.addEventListener('click', () => {
        const hints = button.nextElementSibling as HTMLElement;
        const expanded = button.getAttribute('aria-expanded') === 'true';

        button.setAttribute('aria-expanded', (!expanded).toString());
        if (hints) hints.hidden = expanded;
      });
    });

    // Initial completion check
    checkCompletion(assessment, dayNumber);
  });

  function updateCounts(assessment: Element, dayNumber: number) {
    const checkedItems = getChallengeChecks(dayNumber);

    // Update tier badges
    assessment.querySelectorAll('.assessment__tier-badge').forEach((badge) => {
      const tier = badge.getAttribute('data-tier');
      const section = assessment.querySelector(`.assessment__section[data-tier="${tier}"]`);
      if (!section) return;

      const total = section.querySelectorAll('input[type="checkbox"]').length;
      const completed = section.querySelectorAll('input[type="checkbox"]:checked').length;

      const countEl = badge.querySelector('.count-completed');
      if (countEl) countEl.textContent = completed.toString();

      badge.setAttribute('data-completed', (completed === total).toString());
    });

    // Update section counts
    assessment.querySelectorAll('.assessment__section').forEach((section) => {
      const total = section.querySelectorAll('input[type="checkbox"]').length;
      const completed = section.querySelectorAll('input[type="checkbox"]:checked').length;

      const countEl = section.querySelector('.section-completed');
      if (countEl) countEl.textContent = completed.toString();
    });
  }

  function checkCompletion(assessment: Element, dayNumber: number) {
    const requiredSection = assessment.querySelector('.assessment__section[data-tier="required"]');
    if (!requiredSection) return;

    const requiredTotal = requiredSection.querySelectorAll('input[type="checkbox"]').length;
    const requiredCompleted = requiredSection.querySelectorAll('input[type="checkbox"]:checked').length;

    const completionMessage = assessment.querySelector('.assessment__completion') as HTMLElement;

    if (requiredCompleted === requiredTotal && requiredTotal > 0) {
      completeDayChallenge(dayNumber);
      if (completionMessage) completionMessage.hidden = false;

      // Dispatch event for other components
      window.dispatchEvent(new CustomEvent('progress-updated', { detail: { dayNumber } }));
    } else {
      if (completionMessage) completionMessage.hidden = true;
    }
  }
</script>
