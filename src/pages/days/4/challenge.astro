---
/**
 * Day 4 Challenge Page
 */

import DayLayout from '@/layouts/DayLayout.astro';
import SelfAssessment from '@/components/course/SelfAssessment.astro';
import { getDayChallenge, getSectionsInfo } from '@/lib/content';

// Don't build Day 4 challenge in production (GitHub Pages)
if (import.meta.env.PROD) {
  return Astro.redirect('/');
}

const dayNumber = 4;
const challenge = await getDayChallenge(dayNumber);
const sections = await getSectionsInfo(dayNumber);

const sidebarSections = sections
  .filter((s) => s.order > 0)
  .map((s) => ({ slug: s.slug, title: s.title, order: s.order }));

if (!challenge) {
  return Astro.redirect(`/days/${dayNumber}`);
}

const { Content, headings } = await challenge.render();
---

<DayLayout
  title={`Challenge - Day ${dayNumber}`}
  dayNumber={dayNumber}
  sections={sidebarSections}
  currentSection="challenge"
  headings={headings}
>
  <Content />

  <div class="assessment-section">
    <h2>Self Assessment</h2>
    <p class="assessment-intro">
      Check off each item as you complete it. Your progress is saved automatically.
      Complete all <strong>Required</strong> items to unlock Day 5.
    </p>

    <SelfAssessment
      dayNumber={dayNumber}
      requirements={challenge.data.requirements}
    />
  </div>

  {challenge.data.resources && challenge.data.resources.length > 0 && (
    <div class="resources-section">
      <h2>Resources</h2>
      <ul class="resources-list">
        {challenge.data.resources.map((resource) => (
          <li>
            <a href={resource.url} target="_blank" rel="noopener noreferrer">
              {resource.title}
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" />
                <polyline points="15 3 21 3 21 9" />
                <line x1="10" y1="14" x2="21" y2="3" />
              </svg>
            </a>
          </li>
        ))}
      </ul>
    </div>
  )}

  <Fragment slot="pagination">
    <div class="challenge-nav">
      <a href={`/days/${dayNumber}/controlled-disasters`} class="nav-link nav-link--prev">
        ‚Üê Back to Controlled Disasters
      </a>
      <a href={`/days/${dayNumber + 1}`} class="nav-link nav-link--next nav-link--locked" id="next-day-link">
        <span class="lock-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="11" width="18" height="11" rx="2" ry="2" />
            <path d="M7 11V7a5 5 0 0 1 10 0v4" />
          </svg>
        </span>
        Day 5: Multi-Agent Capstone
      </a>
    </div>
  </Fragment>
</DayLayout>

<style>
  .assessment-section {
    margin-top: 3rem;
    padding-top: 2rem;
    border-top: var(--border-subtle);
  }

  .assessment-section h2 {
    font-size: 1.5rem;
    margin-bottom: 0.5rem;
  }

  .assessment-intro {
    color: var(--color-text-secondary);
    margin-bottom: 1.5rem;
  }

  .resources-section {
    margin-top: 3rem;
    padding-top: 2rem;
    border-top: var(--border-subtle);
  }

  .resources-section h2 {
    font-size: 1.25rem;
    margin-bottom: 1rem;
  }

  .resources-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .resources-list a {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--color-accent-primary);
    text-decoration: none;
  }

  .resources-list a:hover {
    text-decoration: underline;
  }

  .resources-list svg {
    width: 1rem;
    height: 1rem;
  }

  .challenge-nav {
    display: flex;
    justify-content: space-between;
    gap: 1rem;
  }

  .nav-link {
    padding: 0.75rem 1.25rem;
    border-radius: var(--radius-md);
    text-decoration: none;
    font-weight: 500;
    transition: all 0.2s ease;
  }

  .nav-link--prev {
    color: var(--color-text-secondary);
    background: var(--color-bg-elevated);
    border: 1px solid var(--border-subtle);
  }

  .nav-link--prev:hover {
    background: var(--color-bg-secondary);
  }

  .nav-link--next {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: white;
    background: var(--color-day-5);
  }

  .nav-link--next:hover {
    opacity: 0.9;
  }

  .nav-link--locked {
    opacity: 0.5;
    pointer-events: none;
    background: var(--color-text-muted);
  }

  .nav-link--locked.unlocked {
    opacity: 1;
    pointer-events: auto;
    background: var(--color-day-5);
  }

  .lock-icon {
    width: 1rem;
    height: 1rem;
  }

  .nav-link--locked.unlocked .lock-icon {
    display: none;
  }
</style>

<script>
  import { isDayUnlocked } from '@/lib/progress';

  const nextDayLink = document.getElementById('next-day-link');
  if (nextDayLink && isDayUnlocked(5)) {
    nextDayLink.classList.add('unlocked');
  }

  window.addEventListener('progress-updated', () => {
    if (nextDayLink && isDayUnlocked(5)) {
      nextDayLink.classList.add('unlocked');
    }
  });
</script>
